@model YourTurn.Web.Controllers.AdminDashboardViewModel
@{
    ViewData["Title"] = "Admin Dashboard";
    Layout = "_Layout";
}

<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Admin Dashboard</h2>
                <div>
                    <span class="text-muted">Hoş geldin, @User.Identity?.Name</span>
                    <span class="badge bg-success ms-2" id="autoRefreshStatus">
                        <i class="fas fa-sync-alt me-1"></i>Otomatik Güncelleme Aktif
                    </span>
                    <a href="@Url.Action("ChangeUsername", "Admin")" class="btn btn-outline-info ms-2">
                        <i class="fas fa-user-edit me-1"></i>Kullanıcı Adı Değiştir
                    </a>
                    <a href="@Url.Action("ChangePassword", "Admin")" class="btn btn-outline-warning ms-2">
                        <i class="fas fa-key me-1"></i>Şifre Değiştir
                    </a>
                    <a href="@Url.Action("Logout", "Admin")" class="btn btn-outline-danger ms-2">Çıkış</a>
                </div>
            </div>
        </div>
    </div>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- İstatistik Kartları -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title">Toplam Oyuncu</h4>
                            <h2 class="mb-0" id="totalPlayers">@Model.TotalPlayers</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-users fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title">Toplam Lobi</h4>
                            <h2 class="mb-0" id="totalLobbies">@Model.TotalLobbies</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-gamepad fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title">Aktif Lobi</h4>
                            <h2 class="mb-0" id="activeLobbies">@Model.ActiveLobbies</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-play-circle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title">Aktif Oyuncu</h4>
                            <h2 class="mb-0" id="activePlayers">@Model.ActivePlayers</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-user-check fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hızlı Erişim Butonları -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Hızlı Erişim</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-2">
                            <a href="@Url.Action("Players", "Admin")" class="btn btn-outline-primary w-100">
                                <i class="fas fa-users me-2"></i>Oyuncular
                            </a>
                        </div>
                        <div class="col-md-3 mb-2">
                            <a href="@Url.Action("Lobbies", "Admin")" class="btn btn-outline-success w-100">
                                <i class="fas fa-gamepad me-2"></i>Lobiler
                            </a>
                        </div>
                        <div class="col-md-3 mb-2">
                            <a href="@Url.Action("Settings", "Admin")" class="btn btn-outline-warning w-100">
                                <i class="fas fa-cog me-2"></i>Ayarlar
                            </a>
                        </div>
                        <div class="col-md-3 mb-2">
                            <a href="@Url.Action("Logs", "Admin")" class="btn btn-outline-info w-100">
                                <i class="fas fa-list me-2"></i>Loglar
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Aktif Lobiler ve Oyuncular -->
    <div class="row mb-4">
        <!-- Aktif Lobiler -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Aktif Lobiler (<span id="activeLobbiesCount">@Model.ActiveLobbies</span>)</h5>
                </div>
                <div class="card-body">
                    <div id="activeLobbiesContent">
                        @if (Model.CurrentActiveLobbies.Any())
                        {
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Kod</th>
                                            <th>Host</th>
                                            <th>Oyuncu</th>
                                            <th>Durum</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var lobby in Model.CurrentActiveLobbies)
                                        {
                                            <tr>
                                                <td><strong>@lobby.LobbyCode</strong></td>
                                                <td>@lobby.HostPlayerName</td>
                                                <td>@lobby.Players.Count</td>
                                                <td>
                                                    @if (lobby.IsGameStarted)
                                                    {
                                                        <span class="badge bg-success">Oyun Başladı</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-warning">Bekliyor</span>
                                                    }
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <p class="text-muted mb-0">Aktif lobi bulunmuyor.</p>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Aktif Oyuncular -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Aktif Oyuncular (<span id="activePlayersCount">@Model.ActivePlayers</span>)</h5>
                </div>
                <div class="card-body">
                    <div id="activePlayersContent">
                        @if (Model.CurrentActivePlayers.Any())
                        {
                            <div class="row">
                                @foreach (var player in Model.CurrentActivePlayers)
                                {
                                    <div class="col-md-6 mb-2">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-user-circle text-primary me-2"></i>
                                            <span>@player</span>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <p class="text-muted mb-0">Aktif oyuncu bulunmuyor.</p>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Son Aktiviteler -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Son Aktiviteler</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Admin</th>
                                    <th>İşlem</th>
                                    <th>Detay</th>
                                    <th>IP Adresi</th>
                                    <th>Tarih</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var log in Model.RecentLogs)
                                {
                                    <tr>
                                        <td>@log.Admin?.Username</td>
                                        <td>
                                            <span class="badge bg-primary">@log.Action</span>
                                        </td>
                                        <td>@log.Details</td>
                                        <td>@log.IpAddress</td>
                                        <td>@log.CreatedAt.ToString("dd.MM.yyyy HH:mm")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let autoRefreshInterval;
        let isAutoRefreshActive = true;

        // Auto-refresh functionality
        function startAutoRefresh() {
            autoRefreshInterval = setInterval(function() {
                if (isAutoRefreshActive) {
                    updateDashboardData();
                }
            }, 5000); // Update every 5 seconds
        }

        function stopAutoRefresh() {
            clearInterval(autoRefreshInterval);
        }

        function updateDashboardData() {
            fetch('/admin/dashboard-data')
                .then(response => response.json())
                .then(data => {
                    // Update statistics
                    document.getElementById('activeLobbies').textContent = data.activeLobbies;
                    document.getElementById('activePlayers').textContent = data.activePlayers;
                    document.getElementById('activeLobbiesCount').textContent = data.activeLobbies;
                    document.getElementById('activePlayersCount').textContent = data.activePlayers;

                    // Update active lobbies content
                    const lobbiesContent = document.getElementById('activeLobbiesContent');
                    if (data.currentActiveLobbies && data.currentActiveLobbies.length > 0) {
                        let lobbiesHtml = '<div class="table-responsive"><table class="table table-sm"><thead><tr><th>Kod</th><th>Host</th><th>Oyuncu</th><th>Durum</th></tr></thead><tbody>';
                        data.currentActiveLobbies.forEach(lobby => {
                            const status = lobby.isGameStarted ? '<span class="badge bg-success">Oyun Başladı</span>' : '<span class="badge bg-warning">Bekliyor</span>';
                            lobbiesHtml += `<tr><td><strong>${lobby.lobbyCode}</strong></td><td>${lobby.hostPlayerName}</td><td>${lobby.playerCount}</td><td>${status}</td></tr>`;
                        });
                        lobbiesHtml += '</tbody></table></div>';
                        lobbiesContent.innerHTML = lobbiesHtml;
                    } else {
                        lobbiesContent.innerHTML = '<p class="text-muted mb-0">Aktif lobi bulunmuyor.</p>';
                    }

                    // Update active players content
                    const playersContent = document.getElementById('activePlayersContent');
                    if (data.currentActivePlayers && data.currentActivePlayers.length > 0) {
                        let playersHtml = '<div class="row">';
                        data.currentActivePlayers.forEach(player => {
                            playersHtml += `<div class="col-md-6 mb-2"><div class="d-flex align-items-center"><i class="fas fa-user-circle text-primary me-2"></i><span>${player}</span></div></div>`;
                        });
                        playersHtml += '</div>';
                        playersContent.innerHTML = playersHtml;
                    } else {
                        playersContent.innerHTML = '<p class="text-muted mb-0">Aktif oyuncu bulunmuyor.</p>';
                    }

                    // Update refresh status
                    const statusElement = document.getElementById('autoRefreshStatus');
                    statusElement.innerHTML = '<i class="fas fa-sync-alt me-1"></i>Son Güncelleme: ' + new Date().toLocaleTimeString();
                })
                .catch(error => {
                    console.error('Dashboard güncelleme hatası:', error);
                });
        }

        // Toggle auto-refresh
        function toggleAutoRefresh() {
            isAutoRefreshActive = !isAutoRefreshActive;
            const statusElement = document.getElementById('autoRefreshStatus');
            
            if (isAutoRefreshActive) {
                statusElement.className = 'badge bg-success ms-2';
                statusElement.innerHTML = '<i class="fas fa-sync-alt me-1"></i>Otomatik Güncelleme Aktif';
                startAutoRefresh();
            } else {
                statusElement.className = 'badge bg-secondary ms-2';
                statusElement.innerHTML = '<i class="fas fa-pause me-1"></i>Otomatik Güncelleme Duraklatıldı';
                stopAutoRefresh();
            }
        }

        // Make status clickable
        document.addEventListener('DOMContentLoaded', function() {
            const statusElement = document.getElementById('autoRefreshStatus');
            statusElement.style.cursor = 'pointer';
            statusElement.title = 'Otomatik güncellemeyi aç/kapat';
            statusElement.addEventListener('click', toggleAutoRefresh);
            
            // Start auto-refresh
            startAutoRefresh();
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            stopAutoRefresh();
        });
    </script>
} 